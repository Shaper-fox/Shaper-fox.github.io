<!DOCTYPE html>
<html lang="zh-cn" itemscope itemtype="http://schema.org/WebPage">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>浅谈Tornado - Wallis</title>
  

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="bomir" />
  <meta name="description" content="高并发处理框架—Tornado Tornado介绍 ​ Tornado是一个可扩展的非阻塞式Web服务器及其相关工具的开源版本。Tornado每秒" />

  <meta name="keywords" content="Hugo, theme, jane" />






<meta name="generator" content="Hugo 0.85.0" />


<link rel="canonical" href="https://bomir.github.io/post/basic-tornado/" />





<link rel="icon" href="/favicon.ico" />











<link rel="stylesheet" href="/sass/jane.min.b3a8813c06e6d785beba22bf8264e174fa2cb3a396b22f9ba24e2c00c18aaf7f.css" integrity="sha256-s6iBPAbm14W&#43;uiK/gmThdPoss6OWsi&#43;bok4sAMGKr38=" media="screen" crossorigin="anonymous">





<meta property="og:title" content="浅谈Tornado" />
<meta property="og:description" content="高并发处理框架—Tornado Tornado介绍 ​ Tornado是一个可扩展的非阻塞式Web服务器及其相关工具的开源版本。Tornado每秒" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bomir.github.io/post/basic-tornado/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2019-07-03T17:51:08+00:00" />
<meta property="article:modified_time" content="2019-07-03T17:51:08+00:00" />

<meta itemprop="name" content="浅谈Tornado">
<meta itemprop="description" content="高并发处理框架—Tornado Tornado介绍 ​ Tornado是一个可扩展的非阻塞式Web服务器及其相关工具的开源版本。Tornado每秒"><meta itemprop="datePublished" content="2019-07-03T17:51:08+00:00" />
<meta itemprop="dateModified" content="2019-07-03T17:51:08+00:00" />
<meta itemprop="wordCount" content="11451">
<meta itemprop="keywords" content="Tornado," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="浅谈Tornado"/>
<meta name="twitter:description" content="高并发处理框架—Tornado Tornado介绍 ​ Tornado是一个可扩展的非阻塞式Web服务器及其相关工具的开源版本。Tornado每秒"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->




</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">秤流沙</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://bomir.github.io/">首页</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://bomir.github.io/post/">归档</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://bomir.github.io/tags/">标签</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://bomir.github.io/categories/">分类</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://bomir.github.io/about/">关于我</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://github.com/Bicomir" rel="noopener" target="_blank">
              Github
              
              <i class="iconfont">
                <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M623.36 272.96 473.216 423.04C467.2 429.056 467.072 438.656 472.896 444.416c0 0-6.72-6.656 1.6 1.6C496.064 467.648 528.64 500.224 528.64 500.224 534.464 506.048 544 505.856 550.016 499.904l150.08-150.144 67.328 66.432c9.024 8.96 27.456 4.544 30.4-8.96 19.968-92.608 46.656-227.52 46.656-227.52 6.848-34.496-16.192-56.704-49.92-49.92 0 0-134.656 26.816-227.328 46.784C560.32 178.048 556.352 182.272 554.752 187.136c-3.2 6.208-3.008 14.208 3.776 20.992L623.36 272.96z"></path>
  <path d="M841.152 457.152c-30.528 0-54.784 24.512-54.784 54.656l0 274.752L237.696 786.56 237.696 237.696l206.016 0c6.656 0 10.752 0 13.248 0C487.68 237.696 512 213.184 512 182.848 512 152.32 487.36 128 456.96 128L183.04 128C153.216 128 128 152.576 128 182.848c0 3.136 0.256 6.272 0.768 9.28C128.256 195.136 128 198.272 128 201.408l0 639.488c0 0.064 0 0.192 0 0.256 0 0.128 0 0.192 0 0.32 0 30.528 24.512 54.784 54.784 54.784l646.976 0c6.592 0 9.728 0 11.712 0 28.736 0 52.928-22.976 54.464-51.968C896 843.264 896 842.304 896 841.344l0-20.352L896 561.408 896 512.128C896 481.792 871.424 457.152 841.152 457.152z"></path>
</svg>

              </i>
            </a>
          
        
      </li>
    

    
  </ul>
</nav>


  
    






  <link rel="stylesheet" href="/lib/photoswipe/photoswipe.min.css" />
  <link rel="stylesheet" href="/lib/photoswipe/default-skin/default-skin.min.css" />




<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

  

  

  

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="/" class="logo">
    
      秤流沙
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://bomir.github.io/">首页</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://bomir.github.io/post/">归档</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://bomir.github.io/tags/">标签</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://bomir.github.io/categories/">分类</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://bomir.github.io/about/">关于我</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://github.com/Bicomir" rel="noopener" target="_blank">
              Github
              
              <i class="iconfont">
                <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M623.36 272.96 473.216 423.04C467.2 429.056 467.072 438.656 472.896 444.416c0 0-6.72-6.656 1.6 1.6C496.064 467.648 528.64 500.224 528.64 500.224 534.464 506.048 544 505.856 550.016 499.904l150.08-150.144 67.328 66.432c9.024 8.96 27.456 4.544 30.4-8.96 19.968-92.608 46.656-227.52 46.656-227.52 6.848-34.496-16.192-56.704-49.92-49.92 0 0-134.656 26.816-227.328 46.784C560.32 178.048 556.352 182.272 554.752 187.136c-3.2 6.208-3.008 14.208 3.776 20.992L623.36 272.96z"></path>
  <path d="M841.152 457.152c-30.528 0-54.784 24.512-54.784 54.656l0 274.752L237.696 786.56 237.696 237.696l206.016 0c6.656 0 10.752 0 13.248 0C487.68 237.696 512 213.184 512 182.848 512 152.32 487.36 128 456.96 128L183.04 128C153.216 128 128 152.576 128 182.848c0 3.136 0.256 6.272 0.768 9.28C128.256 195.136 128 198.272 128 201.408l0 639.488c0 0.064 0 0.192 0 0.256 0 0.128 0 0.192 0 0.32 0 30.528 24.512 54.784 54.784 54.784l646.976 0c6.592 0 9.728 0 11.712 0 28.736 0 52.928-22.976 54.464-51.968C896 843.264 896 842.304 896 841.344l0-20.352L896 561.408 896 512.128C896 481.792 871.424 457.152 841.152 457.152z"></path>
</svg>

              </i>
            </a>
          

        

      </li>
    

    
    

    
  </ul>
</nav>

  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
    
    <header class="post-header">
      <h1 class="post-title">浅谈Tornado</h1>
      
      <div class="post-meta">
        <time datetime="2019-07-03" class="post-time">
          2019-07-03
        </time>
        <div class="post-category">
            <a href="https://bomir.github.io/categories/python/"> Python </a>
            
          </div>
        <span class="more-meta"> 约 11451 字 </span>
          <span class="more-meta"> 预计阅读 23 分钟 </span>

        
        

        
        
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#高并发处理框架tornado">高并发处理框架—Tornado</a>
      <ul>
        <li><a href="#tornado介绍">Tornado介绍</a></li>
        <li><a href="#tornado框架知识">Tornado框架知识</a></li>
        <li><a href="#开发tornado网站">开发Tornado网站</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>

    
    <div class="post-content">
      <h2 id="高并发处理框架tornado">高并发处理框架—Tornado</h2>
<h3 id="tornado介绍">Tornado介绍</h3>
<p>​	Tornado是一个可扩展的非阻塞式Web服务器及其相关工具的开源版本。Tornado每秒可以处理数以千计的；连接，对于实时的Web服务来说，Tornado是一个理想的Web框架。</p>
<p>​	Tornado是使用Python编写的一个强大的可扩展的Web服务器，它在处理高网络流量时表现得足够强健,却在创建和编写时有着足够的轻量级，并且能够被用在大量的应用和工具中。相比于其他的Python网络框架，Tornado有如下特点。</p>
<ul>
<li>
<p>完备的Web框架：与Django，Flask等一样，Tornado也提供了URL路由映射、Request上下文、基于模板的页面渲染技术等开发Web应用的必备工具。</p>
</li>
<li>
<p>是一个高效的网络库，性能与Twisted、Gevent等底层Python框架相媲美：提供了异步I/O支持、超时事件处理。这使得Tornado除了可以作为Web应用服务器框架，还可以用来做爬虫应用、物联网关、游戏服务器等后台应用。</p>
</li>
<li>
<p>提供高效的HTTPClient：除了服务器端框架，Tornado还提供了基于异步框架的HTTP客户端。</p>
</li>
<li>
<p>提供高效的内部HTTP服务器：虽然其他Python网络框架（Django，Flask）也提供了内部HTTP服务器，但它们的HTTP服务器由于性能原因只能用于测试环境。而Tornado的HTTP服务器与Tornado异步调用紧密结合，可以直接用于生产环境。</p>
</li>
<li>
<p>完备的WebSocket支持：WebSocket是HTML5的一种新标准，实现了浏览器与服务器之间的双向实时通信。</p>
<p>因为Tornado的上述特点，Tornado常被用作大型站点的接口服务框架，而不像Django那样着眼于建立完整的大型网站，着重讲解Tornado的异步及协程编程、身份认证框架、独特的非WSGI部署方式。</p>
</li>
</ul>
<h4 id="安装tornado">安装Tornado</h4>
<p>​	Tornado已经被配置到PyPI网站中，使得Tornado的安装非常简单。在Windows和Linux中都可以通过一条pip命令来完成安装。</p>
<p>​	<code>pip install tornado</code></p>
<p>​	该条命令可以运行在操作系统中或python虚环境中。安装信息如下图所示：</p>
<p>​	<img src="http://a2.qpic.cn/psb?/V11LBpl80UoTHW/Jm50BeD7cX0qxRLR7i1V7XbK42nzk7CANR1XpQtRz2Y!/m/dDUBAAAAAAAAnull&amp;bo=DwR9AgAAAAADB1Y!&amp;rf=photolist&amp;t=5" alt=""></p>
<h4 id="异步及协程基础">异步及协程基础</h4>
<p>​	协程是Tornado中推荐的编程方式，使用协程可以开发出简捷，高效的异步处理代码。本章从同步I/O、异步I/O开始，逐步理解和掌握基于Tornado协程的编程技术。</p>
<h5 id="同步和异步io">同步和异步I/O</h5>
<p>​	从计算机硬件发展的角度来看，当今计算机系统的CPU和内存发展速度日新月异，摩尔定律体现的十分明显。与之同时的硬盘、网络等于I/O相关的速度指标却进度缓慢。因此，在如今的计算机应用开发中，减少程序在I/O操作中的等待是对资源消耗、提高并发程度的必要考虑。</p>
<p>​	根据<em>Unix Network Programing</em> 一书中的定义，同步I/O操作(<em>synchronous I/O operation</em>)导致请求进程阻塞，直到I/O操作完成；异步I/O操作（asynchronous I/O operation）不导致请求进程阻塞。在Python中，同步I/O可以被理解为一个被调用的I/O函数会阻塞调用函数的执行，而异步I/O则不会阻塞调用函数的执行。代码举例如下:</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#000;font-weight:bold">from</span> <span style="color:#555">tornado.httpclient</span> <span style="color:#000;font-weight:bold">import</span> HTTPClient			<span style="color:#998;font-style:italic">#Tornado的HTTP客户端</span>

<span style="color:#000;font-weight:bold">def</span> <span style="color:#900;font-weight:bold">synchronous_visit</span>():
    http_client <span style="color:#000;font-weight:bold">=</span> HTTPClient()
	response <span style="color:#000;font-weight:bold">=</span> http_client<span style="color:#000;font-weight:bold">.</span>fetch(<span style="color:#d14">&#34;www.baidu.com&#34;</span>)	<span style="color:#998;font-style:italic">#阻塞，直到对www.baidu.com访问完成</span>
    <span style="color:#0086b3">print</span>(response<span style="color:#000;font-weight:bold">.</span>body)
</code></pre></td></tr></table>
</div>
</div><p>​	HTTPClient是Tornado的同步访问HTTP客户端。上述代码中的synchronous_visit()函数使用了典型的同步I/O操作访问www.baidu.com网站，该函数的执行时间取决于网络速度、对方服务器响应速度等，只有等到对www.baidu.com的访问完成后并获取到结果后，才能完成对synchronous_visit函数的执行。</p>
<p>​	而使用异步I/O访问www.baidu.com网站的函数无需等待访问完成才能返回，譬如：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#000;font-weight:bold">from</span> <span style="color:#555">tornado.httpclient</span> <span style="color:#000;font-weight:bold">import</span> AsyncHTTPClient

<span style="color:#000;font-weight:bold">def</span> <span style="color:#900;font-weight:bold">handle_response</span>(response):
    <span style="color:#0086b3">print</span>(response<span style="color:#000;font-weight:bold">.</span>body)
    
<span style="color:#000;font-weight:bold">def</span> <span style="color:#900;font-weight:bold">asynchronous_visit</span>():
    http_client <span style="color:#000;font-weight:bold">=</span> AsyncHTTPClient()
    http_client<span style="color:#000;font-weight:bold">.</span>fetch(<span style="color:#d14">&#34;www.baidu.com&#34;</span>,callback<span style="color:#000;font-weight:bold">=</span>handle_response)
</code></pre></td></tr></table>
</div>
</div><p>​	AsyncHTTPClient是Tornado的异步访问HTTP客户端。在上述代码的asynchronous_visit函数中使用AsyncHTTPClient对第三方网站进行异步访问，http_client.fetch()函数会在调用后立刻返回而无需等待实际返回的完成，从而导致asynchronous_visit()也会立刻执行完成。当对www.baidu.com的访问实际完成后，AsyncHTTPClient会调用callback参数指定的函数，开发者可以在其中写入处理访问结果的逻辑代码。</p>
<h5 id="yield关键字">yield关键字</h5>
<p>​	协程是Tornado中进行异步I/O代码开发的方法，协程使用了Python的关键字yield将调用者挂起和恢复执行。在理解协程概念前，应首先理解Python中yield关键字的概念和使用方法，而学习yield之前需要了解迭代器的概念。</p>
<p>​	<strong>1. 迭代器</strong></p>
<p>​	迭代器(Iterator)是访问集合内元素的一种方式。迭代器对象从集合的第1个元素开始访问，直到所有元素都被访问一遍后结束。迭代器不能回退，只能往前进行迭代。</p>
<p>​	Python中最常使用迭代器的场景是循环语句for，它用迭代器封装集合，并且逐个访问集合元素以执行循环体。比如：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#000;font-weight:bold">for</span> number <span style="color:#000;font-weight:bold">in</span> <span style="color:#0086b3">range</span>(<span style="color:#099">6</span>):		<span style="color:#998;font-style:italic">#range返回一个列表</span>
    <span style="color:#0086b3">print</span>(number)
</code></pre></td></tr></table>
</div>
</div><p>​	其中的range()返回一个包含所指定元素的集合，而for语句将其封装一个迭代器后访问，使用iter()调用可以将列表、集合转换为迭代器，比如：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">wjq<span style="color:#3c5d5d;font-weight:bold">@Ubuntu</span>:<span style="color:#000;font-weight:bold">~</span><span style="color:#a61717;background-color:#e3d2d2">$</span> python
Python <span style="color:#099">2.7.12</span> (default, Jul <span style="color:#099">18</span> <span style="color:#099">2016</span>, <span style="color:#099">15</span>:<span style="color:#099">02</span>:<span style="color:#099">52</span>) 
[GCC <span style="color:#099">4.8.4</span>] on linux2
Type <span style="color:#d14">&#34;help&#34;</span>, <span style="color:#d14">&#34;copyright&#34;</span>, <span style="color:#d14">&#34;credits&#34;</span> <span style="color:#000;font-weight:bold">or</span> <span style="color:#d14">&#34;license&#34;</span> <span style="color:#000;font-weight:bold">for</span> more information<span style="color:#000;font-weight:bold">.</span>
<span style="color:#000;font-weight:bold">&gt;&gt;&gt;</span> numbers <span style="color:#000;font-weight:bold">=</span> [<span style="color:#099">1</span>,<span style="color:#099">3</span>,<span style="color:#099">5</span>,<span style="color:#099">7</span>,<span style="color:#099">8</span>]
<span style="color:#000;font-weight:bold">&gt;&gt;&gt;</span> t <span style="color:#000;font-weight:bold">=</span> <span style="color:#0086b3">iter</span>(numbers)
<span style="color:#000;font-weight:bold">&gt;&gt;&gt;</span> <span style="color:#0086b3">print</span>(t)
<span style="color:#000;font-weight:bold">&lt;</span>listiterator <span style="color:#0086b3">object</span> at <span style="color:#099">0x7fd46be79050</span><span style="color:#000;font-weight:bold">&gt;</span>
</code></pre></td></tr></table>
</div>
</div><p>​	其中，t就是迭代器。迭代器与普通的Python对象的区别是迭代器有一个next()方法，每次调用该方法可以返回一个元素。调用者可以通过不断调用next()方法来逐个访问集合元素。比如：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#000;font-weight:bold">&gt;&gt;&gt;</span> <span style="color:#0086b3">iter</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#0086b3">iter</span>(<span style="color:#0086b3">range</span>(<span style="color:#099">6</span>))
<span style="color:#000;font-weight:bold">&gt;&gt;&gt;</span> <span style="color:#0086b3">print</span>(<span style="color:#0086b3">iter</span><span style="color:#000;font-weight:bold">.</span>next())
<span style="color:#099">0</span>
<span style="color:#000;font-weight:bold">&gt;&gt;&gt;</span> <span style="color:#0086b3">print</span>(<span style="color:#0086b3">iter</span><span style="color:#000;font-weight:bold">.</span>next())
<span style="color:#099">1</span>
<span style="color:#000;font-weight:bold">&gt;&gt;&gt;</span> <span style="color:#0086b3">print</span>(<span style="color:#0086b3">iter</span><span style="color:#000;font-weight:bold">.</span>next())
<span style="color:#099">2</span>
<span style="color:#000;font-weight:bold">&gt;&gt;&gt;</span> <span style="color:#0086b3">print</span>(<span style="color:#0086b3">iter</span><span style="color:#000;font-weight:bold">.</span>next())
<span style="color:#000;font-weight:bold">...</span>
</code></pre></td></tr></table>
</div>
</div><p>​	调用者可以一直这样调用next()方法来访问迭代器，直到next()方法返回StopIteration异常以表示迭代已经完成，比如：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#000;font-weight:bold">&gt;&gt;&gt;</span> <span style="color:#0086b3">print</span>(<span style="color:#0086b3">iter</span><span style="color:#000;font-weight:bold">.</span>next())
<span style="color:#099">4</span>
<span style="color:#000;font-weight:bold">&gt;&gt;&gt;</span> <span style="color:#0086b3">print</span>(<span style="color:#0086b3">iter</span><span style="color:#000;font-weight:bold">.</span>next())
<span style="color:#099">5</span>
<span style="color:#000;font-weight:bold">&gt;&gt;&gt;</span> <span style="color:#0086b3">print</span>(<span style="color:#0086b3">iter</span><span style="color:#000;font-weight:bold">.</span>next())
Traceback (most recent call last):
  File <span style="color:#d14">&#34;&lt;stdin&gt;&#34;</span>, line <span style="color:#099">1</span>, <span style="color:#000;font-weight:bold">in</span> <span style="color:#000;font-weight:bold">&lt;</span>module<span style="color:#000;font-weight:bold">&gt;</span>
<span style="color:#900;font-weight:bold">StopIteration</span>
<span style="color:#000;font-weight:bold">&gt;&gt;&gt;</span> 
</code></pre></td></tr></table>
</div>
</div><p>​	<strong>2. 使用yield</strong></p>
<p>​	迭代器在Python编程中适用范围很广，开发者可以使用yield定制自己的迭代器。<em><strong>调用任何定义中包含yield关键字的函数都不会执行该函数，而是会获得一个对应该函数的迭代器。</strong></em></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">code example:
<span style="color:#998;font-style:italic">#!/usr/bin/env python</span>
<span style="color:#998;font-style:italic">#-*- coding:utf-8 -*-</span>

<span style="color:#000;font-weight:bold">def</span> <span style="color:#900;font-weight:bold">demoIterator</span>():     <span style="color:#998;font-style:italic">#定义一个迭代器函数</span>
    <span style="color:#0086b3">print</span>(<span style="color:#d14">&#34;first call of next()&#34;</span>)
    <span style="color:#000;font-weight:bold">yield</span> <span style="color:#099">1</span>
    <span style="color:#0086b3">print</span>(<span style="color:#d14">&#34;second call of next()&#34;</span>)
    <span style="color:#000;font-weight:bold">yield</span> <span style="color:#099">3</span>
    <span style="color:#0086b3">print</span>(<span style="color:#d14">&#34;third call of next()&#34;</span>)
    <span style="color:#000;font-weight:bold">yield</span> <span style="color:#099">9</span>

<span style="color:#000;font-weight:bold">for</span> i <span style="color:#000;font-weight:bold">in</span> demoIterator():
    <span style="color:#0086b3">print</span>(i)
</code></pre></td></tr></table>
</div>
</div><p>​	执行该部分代码结果如下：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">ssh:<span style="color:#000;font-weight:bold">//</span>wjq<span style="color:#000;font-weight:bold">@</span><span style="color:#099">59.68.29</span><span style="color:#000;font-weight:bold">.</span>xx:<span style="color:#099">22</span><span style="color:#000;font-weight:bold">/</span>home<span style="color:#000;font-weight:bold">/</span>wjq<span style="color:#000;font-weight:bold">/</span>TornadoWork<span style="color:#000;font-weight:bold">/</span>tor_env<span style="color:#000;font-weight:bold">/</span><span style="color:#0086b3">bin</span><span style="color:#000;font-weight:bold">/</span>python <span style="color:#000;font-weight:bold">-</span>u <span style="color:#000;font-weight:bold">/</span>home<span style="color:#000;font-weight:bold">/</span>wjq<span style="color:#000;font-weight:bold">/</span>TornadoWork<span style="color:#000;font-weight:bold">/</span>tornado_0<span style="color:#000;font-weight:bold">/</span>temp<span style="color:#000;font-weight:bold">/</span>demo<span style="color:#000;font-weight:bold">/</span><span style="color:#099">7_1.</span>py
first call of <span style="color:#0086b3">next</span>()
<span style="color:#099">1</span>
second call of <span style="color:#0086b3">next</span>()
<span style="color:#099">3</span>
third call of <span style="color:#0086b3">next</span>()
<span style="color:#099">9</span>
</code></pre></td></tr></table>
</div>
</div><p>​	每次调用迭代器的next()函数，将执行迭代器函数。并返回yield的结果作为迭代返回元素。当迭代器函数return时，迭代器会抛出StopIteration异常使迭代终止。</p>
<p>​	注：在Python中，使用yield关键字定义的迭代器也被称为&quot;生成器&quot;。</p>
<h5 id="协程">协程</h5>
<p>​	使用Tornado协程可以开发出类似同步代码的异步行为，并且因为协程本身不使用线程，所以减少了线程上下文切换的开销，是一种更为高效的开发模式。</p>
<p>​	<strong>1.  编写协程函数</strong></p>
<p>​	使用协程技术开发网页访问的代码如下：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#000;font-weight:bold">from</span> <span style="color:#555">tornado</span> <span style="color:#000;font-weight:bold">import</span> gen			<span style="color:#998;font-style:italic">#引入协程库gen</span>
<span style="color:#000;font-weight:bold">from</span> <span style="color:#555">tornado.httpclient</span> <span style="color:#000;font-weight:bold">import</span> AsyncHTTPClient

<span style="color:#3c5d5d;font-weight:bold">@gen</span><span style="color:#000;font-weight:bold">.</span>coroutine					<span style="color:#998;font-style:italic">#使用gen.coroutine修饰器</span>
<span style="color:#000;font-weight:bold">def</span> <span style="color:#900;font-weight:bold">coroutine_visit</span>():
    http_client <span style="color:#000;font-weight:bold">=</span> AsyncHTTPClient()
    response <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">yield</span> http_client<span style="color:#000;font-weight:bold">.</span>fetch(<span style="color:#d14">&#34;www.baidu.com&#34;</span>)
    <span style="color:#0086b3">print</span>(response<span style="color:#000;font-weight:bold">.</span>body)
</code></pre></td></tr></table>
</div>
</div><p>​	本例中仍然使用异步客户端AsyncHTTPClient进行页面访问，使用@gen.coroutine表明用装饰器声明这是一个协程函数。由于yield关键字的使用，使得代码中不用再编写回调函数用于处理访问结果，而可以直接在yield语句的后面编写结果处理语句。</p>
<p>​	<strong>2.  编写协程函数</strong></p>
<p>​	<strong>由于Tornado协程基于Python的yield关键字实现，所以不能像调用普通函数一样调用协程函数。</strong> 协程函数可以通过以下三种方式进行调用。</p>
<ul>
<li>
<p>在本身是协程的函数内通过yield关键字调用。</p>
</li>
<li>
<p>在IOLoop尚未启动时，通过IOLoop的run_sync()函数调用。</p>
</li>
<li>
<p>在IOLoop已经启动时，通过IOLoop的spawn_callback()函数调用。</p>
<p>举一个“通过协程函数调用协程函数”的例子：</p>
</li>
</ul>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#000;font-weight:bold">from</span> <span style="color:#555">tornado</span> <span style="color:#000;font-weight:bold">import</span> gen				<span style="color:#998;font-style:italic"># 引入协程库gen</span>

<span style="color:#3c5d5d;font-weight:bold">@gen</span><span style="color:#000;font-weight:bold">.</span>coroutine
<span style="color:#000;font-weight:bold">def</span> <span style="color:#900;font-weight:bold">outer_coroutine</span>():
    <span style="color:#0086b3">print</span>(<span style="color:#d14">&#34;start call another coroutine&#34;</span>)
    <span style="color:#000;font-weight:bold">yield</span> coroutine_visit()
    <span style="color:#0086b3">print</span>(<span style="color:#d14">&#34;end of outer_coroutine&#34;</span>)
</code></pre></td></tr></table>
</div>
</div><p>​	本例中coroutine_visit和outer_coroutine都是协程函数，所以它们之间可以通过yield关键字进行调用。IOLoop是Tornado的主事件循环对象，Tornado程序通过它监听外部客户端的访问请求，并执行相应的操作。当程序尚未进入IOLoop的running状态时，可以通过run_sync()函数调用协程函数。比如：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#000;font-weight:bold">from</span> <span style="color:#555">tornado.ioloop</span> <span style="color:#000;font-weight:bold">import</span> IOLoop		<span style="color:#998;font-style:italic">#引入IOLoop对象</span>

<span style="color:#000;font-weight:bold">def</span> <span style="color:#900;font-weight:bold">func_normal</span>():
    <span style="color:#0086b3">print</span>(<span style="color:#d14">&#34;start to call a coroutine&#34;</span>)
	IOLoop<span style="color:#000;font-weight:bold">.</span>current()<span style="color:#000;font-weight:bold">.</span>run_sync(<span style="color:#000;font-weight:bold">lambda</span>: coroutine_visit())
    <span style="color:#0086b3">print</span>(<span style="color:#d14">&#34;end of calling a coroutine&#34;</span>)
</code></pre></td></tr></table>
</div>
</div><p>​	此处无需过分了解IOLoop，后面会逐步了解IOLoop的具体概念及应用方法。</p>
<p>​	上例中引用tornado.ioloop包中的IOLoop对象，之后在普通函数中使用run_sync()函数调用经过lambda封装的协程函数。run_sync()函数将阻塞当前函数的执行，直到被调用的协程执行完成。</p>
<p>​	事实上，Tornado要求协程函数在IOLoop的runing状态中才能被调用，只不过run_sync函数自动完成了启动、停止IOLoop的步骤，它的实现逻辑为：启动IOLoop—&gt;调用被lambda封装的协程函数—&gt;停止IOLoop。当Tornado程序已经处于running状态时的协程函数的调用示例如下：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#000;font-weight:bold">from</span> <span style="color:#555">tornado.ioloop</span> <span style="color:#000;font-weight:bold">import</span> IOLoop		<span style="color:#998;font-style:italic">#引入IOLoop对象</span>

<span style="color:#000;font-weight:bold">def</span> <span style="color:#900;font-weight:bold">func_normal</span>():
    <span style="color:#0086b3">print</span>(<span style="color:#d14">&#34;start to call a coroutine&#34;</span>)
    IOLoop<span style="color:#000;font-weight:bold">.</span>current()<span style="color:#000;font-weight:bold">.</span>spawn_callback(coroutine_visit)
    <span style="color:#0086b3">print</span>(<span style="color:#d14">&#34;end of calling a coroutine&#34;</span>)
</code></pre></td></tr></table>
</div>
</div><p>​	本例中spawn_callback()函数将不会等待被调用协程执行完成。所以spawn_callback()之前和之后的print语句将会被连续执行，而coroutine_visit本身将会由IOLoop在合适的时机进行调用。</p>
<p>​	IOLoop的spawn_callback()函数没有为开发者提供获取协程函数调用返回值的方法，所以只能用spawn_callback()调用没有返回值的协程函数。</p>
<p>​	<strong>3.  在协程中调用阻塞函数</strong></p>
<p>​	在协程中直接调用阻塞函数会影响协程本身的性能，所以Tornado提供了在协程中利用线程池调度阻塞函数，从而不影响协程本身继续执行的方法。示例如下：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#000;font-weight:bold">from</span> <span style="color:#555">concurrent.futures</span> <span style="color:#000;font-weight:bold">import</span> ThreadPoolExecutor

thread_tool <span style="color:#000;font-weight:bold">=</span> ThreadPoolExecutor(<span style="color:#099">2</span>)
<span style="color:#000;font-weight:bold">def</span> <span style="color:#900;font-weight:bold">mySleep</span>(count):
    <span style="color:#000;font-weight:bold">import</span> <span style="color:#555">time</span>
    <span style="color:#000;font-weight:bold">for</span> i <span style="color:#000;font-weight:bold">in</span> <span style="color:#0086b3">range</span>(count):
        time<span style="color:#000;font-weight:bold">.</span>sleep(<span style="color:#099">1</span>)

<span style="color:#3c5d5d;font-weight:bold">@gen</span><span style="color:#000;font-weight:bold">.</span>coroutine
<span style="color:#000;font-weight:bold">def</span> <span style="color:#900;font-weight:bold">call_blocking</span>():
    <span style="color:#0086b3">print</span>(<span style="color:#d14">&#34;start of call_blocking&#34;</span>)
    <span style="color:#000;font-weight:bold">yield</span> thread_pool<span style="color:#000;font-weight:bold">.</span>submit(mySleep,<span style="color:#099">10</span>)
    <span style="color:#0086b3">print</span>(<span style="color:#d14">&#34;end of call_blocking&#34;</span>)
</code></pre></td></tr></table>
</div>
</div><p>​	代码中首先引用了concurrent.futures中的ThreadPoolExecutor类，并实例化了一个有两个线程的线程池thread_pool。在需要调用阻塞函数的协程call_blocking中，使用thread_pool.submit调用阻塞函数，并通过yield返回。这样便不会阻塞协程所在线程的继续执行，也保证了阻塞函数前后代码的执行顺序。</p>
<p>​	<strong>4.  在协程中等待多个异步调用</strong></p>
<p>​	目前只讲述了协程中一个yield关键字等待一个异步调用，实际上tornado允许在协程中用一个yield关键字等待多个异步调用，只需要把这些调用用列表(list)或字典(dictionary)的方式传递给yield关键字即可。</p>
<p>​	使用列表方式传递多个异步调用的示例代码如下：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#000;font-weight:bold">from</span> <span style="color:#555">tornado</span> <span style="color:#000;font-weight:bold">import</span> gen		<span style="color:#998;font-style:italic"># 引入协程库</span>
<span style="color:#000;font-weight:bold">from</span> <span style="color:#555">tornado.httpclient</span> <span style="color:#000;font-weight:bold">import</span> AsyncHTTPClient

<span style="color:#3c5d5d;font-weight:bold">@gen</span><span style="color:#000;font-weight:bold">.</span>coroutine				<span style="color:#998;font-style:italic"># 使用gen.coroutine修饰器</span>
<span style="color:#000;font-weight:bold">def</span> <span style="color:#900;font-weight:bold">coroutine_visit</span>():
    http_client <span style="color:#000;font-weight:bold">=</span> AsyncHTTPClient()
    list_response <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">yield</span>[ http_client<span style="color:#000;font-weight:bold">.</span>fetch(<span style="color:#d14">&#34;www.baidu.com&#34;</span>),
                         http_client<span style="color:#000;font-weight:bold">.</span>fetch(<span style="color:#d14">&#34;www.sina.com&#34;</span>),
                        http_client<span style="color:#000;font-weight:bold">.</span>fetch(<span style="color:#d14">&#34;www.163.com&#34;</span>),
                        http_client<span style="color:#000;font-weight:bold">.</span>fetch(<span style="color:#d14">&#34;www.google.com&#34;</span>)
                         ]
   <span style="color:#000;font-weight:bold">for</span> response <span style="color:#000;font-weight:bold">in</span> list_response:
       <span style="color:#0086b3">print</span> response<span style="color:#000;font-weight:bold">.</span>body
</code></pre></td></tr></table>
</div>
</div><p>​	在代码中仍然用@gen.coroutine装饰器定义协程，在需要yield的地方用列表传递若干个异步调用，只有在列表中的所有调用都执行完成后，yield才会返回并继续执行。yield以列表形式返回N个调用的输出结果，可以通过for语句逐个访问。</p>
<p>​	使用字典方式传递多个异步调用的示例代码如下：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#000;font-weight:bold">from</span> <span style="color:#555">tornado</span> <span style="color:#000;font-weight:bold">import</span> gen		<span style="color:#998;font-style:italic"># 引入协程库</span>
<span style="color:#000;font-weight:bold">from</span> <span style="color:#555">tornado.httpclient</span> <span style="color:#000;font-weight:bold">import</span> AsyncHTTPClient

<span style="color:#3c5d5d;font-weight:bold">@gen</span><span style="color:#000;font-weight:bold">.</span>coroutine				<span style="color:#998;font-style:italic"># 使用gen.coroutine修饰器</span>
<span style="color:#000;font-weight:bold">def</span> <span style="color:#900;font-weight:bold">coroutine_visit</span>():
    http_client <span style="color:#000;font-weight:bold">=</span> AsyncHTTPClient()
    dict_response <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">yield</span>[ <span style="color:#d14">&#34;baidu&#34;</span>: http_client<span style="color:#000;font-weight:bold">.</span>fetch(<span style="color:#d14">&#34;www.baidu.com&#34;</span>),
                         <span style="color:#d14">&#34;sina&#34;</span>: http_client<span style="color:#000;font-weight:bold">.</span>fetch(<span style="color:#d14">&#34;www.sina.com&#34;</span>),
                        <span style="color:#d14">&#34;163&#34;</span>: http_client<span style="color:#000;font-weight:bold">.</span>fetch(<span style="color:#d14">&#34;www.163.com&#34;</span>),
                        <span style="color:#d14">&#34;google&#34;</span>: http_client<span style="color:#000;font-weight:bold">.</span>fetch(<span style="color:#d14">&#34;www.google.com&#34;</span>)
                         ]
 <span style="color:#0086b3">print</span> dict_response[<span style="color:#d14">&#34;sina&#34;</span>]<span style="color:#000;font-weight:bold">.</span>body
</code></pre></td></tr></table>
</div>
</div><p>​	本例中以字典形式给yield关键字传递异步调用要求，并且Tornado以字典形式返回异步调用的结果。</p>
<h3 id="tornado框架知识">Tornado框架知识</h3>
<h4 id="tornado概述">Tornado概述</h4>
<p>​	Tornado全称是Tornado Web Server，是一个用Python语言写成的Web服务器兼网络框架。特点和性能总结如下：</p>
<p>​	<strong>特点：</strong></p>
<ul>
<li>
<p>轻量级的Web框架，其拥有异步非阻塞IO的处理方式。</p>
</li>
<li>
<p>作为Web服务器，Tornado有较为出色的抗负载能力，官方用Nginx反向代理的方式部署Tornado和其它Python Web应用框架，为了最大化的利用Tornado的性能，推荐同时使用tornado和其它Python Web应用框架进行对比，结果最大浏览量超过第二名近40%.</p>
<p><strong>性能：</strong></p>
</li>
<li>
<p>Tornado性能优异，它试图解决 <a href="https://www.jianshu.com/p/ba7fa25d3590">C10K</a>问题，即处理大于或等于一万的并发连接。</p>
<p>Tornado框架和服务器一起可以组成一个WSGI的全栈替代品，如果单独在WSGI容器中使用tornado网络框架或者tornaod http服务器 ，存在一定的局限性。为了最大化的利用tornado的性能，推荐同时使用tornado+HTTP服务器。</p>
</li>
</ul>
<h4 id="应用场景">应用场景</h4>
<ul>
<li>
<p>用户量大，高并发</p>
<p>如秒杀抢购，双11某宝购物、春节抢火车票等。</p>
</li>
<li>
<p>大量的HTTP持久连接</p>
</li>
</ul>
<p>​        使用同一个TCP连接来发送和接收多个HTTP请求 or 应答，而不是为每一个请求 or 应答打开新的连接的方法。</p>
<p>​	对于HTTP 1.0，可以在请求的包头(Header)中添加Connection:Keep-Alive。</p>
<p>​	对于HTTP 1.1，所有的连接默认为持久连接。</p>
<h4 id="tornado与django比较">Tornado与Django比较</h4>
<p>​	<strong>Tornado</strong></p>
<p>​	Tornado走的是少而精的方向，注重的是性能优越，最为出名的是它的异步非阻塞的设计方式。</p>
<ul>
<li>
<p>HTTP服务器</p>
</li>
<li>
<p>异步编程</p>
</li>
<li>
<p>WebSocket</p>
<p><strong>Djangoo</strong></p>
<p>Django走的是大而全的方向，注重开发高效，最为出名的是它自动化的管理后台，只需要使用起ORM，做简单的对象定义，它就能自动生成数据库，以及功能齐全的管理后台。</p>
<p>Django所提供的方便，意味着Django内置的ORM跟框架内的其他模块耦合度高，应用程序必须使用Django内置的ORM，否则就不能享受到框架内提供的种种基于ORM的便利。</p>
</li>
<li>
<p>Session功能</p>
</li>
<li>
<p>后台管理</p>
</li>
<li>
<p>ORM</p>
</li>
</ul>
<h4 id="简单tornado示例">简单Tornado示例</h4>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#998;font-style:italic">#-*- coding:utf-8 -*-</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">tornado.httpserver</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">tornado.ioloop</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">tornado.web</span>

<span style="color:#000;font-weight:bold">from</span> <span style="color:#555">tornado.options</span> <span style="color:#000;font-weight:bold">import</span> define,options
define(<span style="color:#d14">&#34;port&#34;</span>,default<span style="color:#000;font-weight:bold">=</span><span style="color:#099">8000</span>,help<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;run on the given port&#34;</span>,<span style="color:#0086b3">type</span><span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">int</span>)
<span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">IndexHandler</span>(tornado<span style="color:#000;font-weight:bold">.</span>web<span style="color:#000;font-weight:bold">.</span>RequestHandler):
    <span style="color:#d14">&#39;&#39;&#39;主路由处理类&#39;&#39;&#39;</span>
    <span style="color:#000;font-weight:bold">def</span> <span style="color:#900;font-weight:bold">get</span>(<span style="color:#999">self</span>):
        <span style="color:#d14">&#39;&#39;&#39;对应http的get请求方式&#39;&#39;&#39;</span>
        greeting <span style="color:#000;font-weight:bold">=</span> <span style="color:#999">self</span><span style="color:#000;font-weight:bold">.</span>get_argument(<span style="color:#d14">&#39;greeting&#39;</span>,<span style="color:#d14">&#39;Hello&#39;</span>)
        <span style="color:#999">self</span><span style="color:#000;font-weight:bold">.</span>write(greeting <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#39;, tornado!&#39;</span>)


<span style="color:#000;font-weight:bold">if</span> __name__ <span style="color:#000;font-weight:bold">==</span> <span style="color:#d14">&#34;__main__&#34;</span>:
    tornado<span style="color:#000;font-weight:bold">.</span>options<span style="color:#000;font-weight:bold">.</span>parse_command_line()
    app <span style="color:#000;font-weight:bold">=</span> tornado<span style="color:#000;font-weight:bold">.</span>web<span style="color:#000;font-weight:bold">.</span>Application(handlers<span style="color:#000;font-weight:bold">=</span>[(<span style="color:#d14">r</span><span style="color:#d14">&#34;/&#34;</span>,IndexHandler)])
    http_server <span style="color:#000;font-weight:bold">=</span> tornado<span style="color:#000;font-weight:bold">.</span>httpserver<span style="color:#000;font-weight:bold">.</span>HTTPServer(app)
    http_server<span style="color:#000;font-weight:bold">.</span>listen(options<span style="color:#000;font-weight:bold">.</span>port)
    tornado<span style="color:#000;font-weight:bold">.</span>ioloop<span style="color:#000;font-weight:bold">.</span>IOLoop<span style="color:#000;font-weight:bold">.</span>instance()<span style="color:#000;font-weight:bold">.</span>start()
</code></pre></td></tr></table>
</div>
</div><p>上述代码解释说明：</p>
<p><strong>tornado的基础Web框架模块</strong></p>
<ul>
<li>
<p>RequestHandler</p>
<p>封装了对应一个请求的所有信息和方法，write(响应信息)就是写响应信息的一个方法；对应每一种http请求方式(get、post等)，把对应的处理逻辑写进同名的成员方法中(如对应get请求方式，就将对应的处理逻辑写在get()方法中)，当没有对应请求方式的成员方法时，会返回“405: Method Not Allowed”错误。</p>
</li>
<li>
<p>Application</p>
<p>Tornado Web框架的核心应用类，是与服务器对接的接口，里面保存了路由信息表，其初始化接收的第一个参数就是一个路由信息映射元组的列表；其listen(端口)方法用来创建一个http服务器实例，并绑定到给定端口(注意：此时服务器并未开启监听)。</p>
</li>
</ul>
<h4 id="tornado核心ioloop循环模块">Tornado核心IOLoop循环模块</h4>
<p>​	tornado的核心io循环模块，封装了Linux的epoll和BSD的kqueue，也是tornado高性能的基石。以Linux的epoll为例，其原理如下图：</p>
<p><a href="https://imgtu.com/i/WwGci6"><img src="https://z3.ax1x.com/2021/07/21/WwGci6.png" alt="WwGci6.png"></a></p>
<p>​	针对具体实例，访问路径如下图：</p>
<p><a href="https://imgtu.com/i/WwGhsH"><img src="https://z3.ax1x.com/2021/07/21/WwGhsH.png" alt="WwGhsH.png"></a></p>
<ul>
<li>IOLoop.current()返回当前线程的IOLoop实例。</li>
<li>IOLoop.start() 启动IOLoop实例的I/O循环，同时服务器监听被打开。</li>
</ul>
<p>2.6 Tornado Web程序编写思路</p>
<ol>
<li>创建Web应用实例对象，第一个初始化参数为路由映射列表。</li>
<li>定义实现路由映射表中的handler类。</li>
<li>创建服务器实例，绑定服务器端口。</li>
<li>启动当前线程的IOLoop。</li>
</ol>
<h3 id="开发tornado网站">开发Tornado网站</h3>
<p>​	下面会展示使用Tornado建立Web站点的方法。</p>
<h4 id="网站结构">网站结构</h4>
<p>​	通过编写hellowowld学习Tornado网站的基本结构：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">tornado.ioloop</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">tornado.web</span>

<span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">MainHandler</span>(tornado<span style="color:#000;font-weight:bold">.</span>web<span style="color:#000;font-weight:bold">.</span>RequestHandler):
    <span style="color:#000;font-weight:bold">def</span> <span style="color:#900;font-weight:bold">get</span>(<span style="color:#999">self</span>):
        <span style="color:#999">self</span><span style="color:#000;font-weight:bold">.</span>write(<span style="color:#d14">&#34;Hello World!&#34;</span>)

<span style="color:#000;font-weight:bold">def</span> <span style="color:#900;font-weight:bold">make_app</span>():
    <span style="color:#000;font-weight:bold">return</span> tornado<span style="color:#000;font-weight:bold">.</span>web<span style="color:#000;font-weight:bold">.</span>Application([(<span style="color:#d14">r</span><span style="color:#d14">&#34;/&#34;</span>,MainHandler),])

<span style="color:#000;font-weight:bold">def</span> <span style="color:#900;font-weight:bold">main</span>():
    app <span style="color:#000;font-weight:bold">=</span> make_app()
    app<span style="color:#000;font-weight:bold">.</span>listen(<span style="color:#099">8888</span>)
    tornado<span style="color:#000;font-weight:bold">.</span>ioloop<span style="color:#000;font-weight:bold">.</span>IOLoop<span style="color:#000;font-weight:bold">.</span>current()<span style="color:#000;font-weight:bold">.</span>start()
    
<span style="color:#000;font-weight:bold">if</span> __name__ <span style="color:#000;font-weight:bold">==</span> <span style="color:#d14">&#34;__main__&#34;</span>:
    main()
</code></pre></td></tr></table>
</div>
</div><p>​	下面逐行解析上面的代码做了些什么。</p>
<p>​	(1) 首先是通过import语句引入tornado包中ioloop和web类。引入这两个类是Tornado程序的基础。</p>
<p>​	(2) 实现一个web.RequestHandler子类，重载其中的get()函数，该函数负责相应定位到该Request</p>
<p>Handler的HTTP GET请求的处理。本例中简单的使用self.write()函数输出hello world。</p>
<p>​	(3) 定义了make_app()函数，该函数返回一个web.Application对象。该对象的第1个参数用于定义Tornado程序的路由映射。本例中将对根URL的访问映射到了RequestHandler子类MainHandler中。</p>
<p>​	(4) 用web.Application.listen()函数指定服务器监听的端口。</p>
<p>​	(5) 用tornado.ioloop.IOLoop.current().start()启动IOLoop，该函数将一直运行且不退出，用于处理完所有的客户端的访问请求。</p>
<h4 id="路由解析">路由解析</h4>
<p>​	向web.Application对象传递的第1个参数URL路由映射列表的配置方式与Django类似，用正则字符串进行路由匹配。Tornado的路由字符串有两种，固定字符路径和参数字串路径。</p>
<ul>
<li>
<p><strong>固定字串路径</strong></p>
<p>固定子串是普通的字符串固定匹配，比如：</p>
</li>
</ul>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">Handlers <span style="color:#000;font-weight:bold">=</span> [(<span style="color:#d14">&#34;/&#34;</span>,MainHandler),					<span style="color:#998;font-style:italic">#只匹配根路径</span>
            (<span style="color:#d14">&#34;/entry&#34;</span>,EntryHandler),			<span style="color:#998;font-style:italic">#只匹配/entry</span>
            (<span style="color:#d14">&#34;/entry/2015&#34;</span>,Entry2015Handler)	<span style="color:#998;font-style:italic">#只匹配/entry/2015</span>
           ]
</code></pre></td></tr></table>
</div>
</div><ul>
<li><strong>参数字串路径</strong></li>
</ul>
<p>​        参数字串可以将具备一定模式的路径映射到同一个RequestHandler中处理，其中路径中的参数部分用小括号&quot;()&ldquo;标识，下面是一个参数路径的例子：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#998;font-style:italic"># url handler</span>
handlers <span style="color:#000;font-weight:bold">=</span> [(<span style="color:#d14">r</span><span style="color:#d14">&#34;/entry/([^/]+)&#34;</span>,EntryHandler),]

<span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">EntryHandler</span>(tornado<span style="color:#000;font-weight:bold">.</span>web<span style="color:#000;font-weight:bold">.</span>RequestHandler):
    <span style="color:#000;font-weight:bold">def</span> <span style="color:#900;font-weight:bold">get</span>(<span style="color:#999">self</span>,slug):
        entry <span style="color:#000;font-weight:bold">=</span> <span style="color:#999">self</span><span style="color:#000;font-weight:bold">.</span>db<span style="color:#000;font-weight:bold">.</span>get(<span style="color:#d14">&#34;SELECT * FROM entries WHERE slug = </span><span style="color:#d14">%s</span><span style="color:#d14">&#34;</span>,slug)
        <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">not</span> entry:
            <span style="color:#000;font-weight:bold">raise</span> tornado<span style="color:#000;font-weight:bold">.</span>web<span style="color:#000;font-weight:bold">.</span>HTTPError(<span style="color:#099">404</span>)
        <span style="color:#999">self</span><span style="color:#000;font-weight:bold">.</span>render(<span style="color:#d14">&#34;entry.html&#34;</span>,entry<span style="color:#000;font-weight:bold">=</span>entry)
</code></pre></td></tr></table>
</div>
</div><p>​	例中用 <code>&quot;/entry/([^/]+)&quot;</code> 定义以/entry/开头的URL模式。小括号的内容是正则表达式，URL尾部的变量部分以参数形式传递给RequestHandler中的get()函数，本例中将该参数命名为slug。</p>
<ul>
<li><strong>带默认值的参数路径</strong></li>
</ul>
<p>​       之前例子中的<code>handlers = [(r&quot;/entry/([^/]+)&quot;,EntryHandler),]</code>模式定义了客户端必须输入路径参数。比如，其能够匹配如下路径：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">http:<span style="color:#000;font-weight:bold">//</span>xx<span style="color:#000;font-weight:bold">.</span>xx<span style="color:#000;font-weight:bold">.</span>xx<span style="color:#000;font-weight:bold">.</span>xx<span style="color:#000;font-weight:bold">/</span>entry<span style="color:#000;font-weight:bold">/</span>abc
http:<span style="color:#000;font-weight:bold">//</span>xx<span style="color:#000;font-weight:bold">.</span>xx<span style="color:#000;font-weight:bold">.</span>xx<span style="color:#000;font-weight:bold">.</span>xx<span style="color:#000;font-weight:bold">/</span>entry<span style="color:#000;font-weight:bold">/</span><span style="color:#099">2019</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">03</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">10</span>
</code></pre></td></tr></table>
</div>
</div><p>​	但是其无法匹配，<code>http://xx.xx.xx.xx/entry</code> ，</p>
<p>​	对于需要匹配客户端未传入时的路径，则需要用如下方法改变URL路径和对get()函数的定义：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#998;font-style:italic"># url handler</span>
handlers <span style="color:#000;font-weight:bold">=</span> [(<span style="color:#d14">r</span><span style="color:#d14">&#34;/entry/([^/]*)&#34;</span>,EntryHandler),]

<span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">EntryHandler</span>(tornado<span style="color:#000;font-weight:bold">.</span>web<span style="color:#000;font-weight:bold">.</span>RequestHandler):
    <span style="color:#000;font-weight:bold">def</span> <span style="color:#900;font-weight:bold">get</span>(<span style="color:#999">self</span>,slug<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;default&#39;</span>):
        entry <span style="color:#000;font-weight:bold">=</span> <span style="color:#999">self</span><span style="color:#000;font-weight:bold">.</span>db<span style="color:#000;font-weight:bold">.</span>get(<span style="color:#d14">&#34;SELECT * FROM entries WHERE slug = </span><span style="color:#d14">%s</span><span style="color:#d14">&#34;</span>,slug)
        <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">not</span> entry:
            <span style="color:#000;font-weight:bold">raise</span> tornado<span style="color:#000;font-weight:bold">.</span>web<span style="color:#000;font-weight:bold">.</span>HTTPError(<span style="color:#099">404</span>)
        <span style="color:#999">self</span><span style="color:#000;font-weight:bold">.</span>render(<span style="color:#d14">&#34;entry.html&#34;</span>,entry<span style="color:#000;font-weight:bold">=</span>entry)
</code></pre></td></tr></table>
</div>
</div><p>​	本例中首先用星号&rdquo;*&ldquo;取代加号&rdquo;+&ldquo;定义了URL模式，然后为RequestHandler子类的get()函数的slug参数配置了默认值default。</p>
<ul>
<li>
<p><strong>多参数路径</strong></p>
<p>参数路径还允许在一个URL模式中定义多个可变参数，比如：</p>
</li>
</ul>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">handlers <span style="color:#000;font-weight:bold">=</span> [
    (<span style="color:#d14">r</span><span style="color:#d14">&#39;/(\d</span><span style="color:#d14">{4}</span><span style="color:#d14">)/(\d</span><span style="color:#d14">{2}</span><span style="color:#d14">)/(\d</span><span style="color:#d14">{2}</span><span style="color:#d14">)/([a-zA-Z\-0-9\.:,_]+)/?&#39;</span>,DetailHandler)
]

<span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">DetailHandler</span>(tornado<span style="color:#000;font-weight:bold">.</span>web<span style="color:#000;font-weight:bold">.</span>RequestHandler):
    <span style="color:#000;font-weight:bold">def</span> <span style="color:#900;font-weight:bold">get</span>(<span style="color:#999">self</span>, year, month, day, slug):
        <span style="color:#999">self</span><span style="color:#000;font-weight:bold">.</span>write(<span style="color:#d14">&#34;</span><span style="color:#d14">%d</span><span style="color:#d14">-</span><span style="color:#d14">%d</span><span style="color:#d14">-</span><span style="color:#d14">%d</span><span style="color:#d14"> </span><span style="color:#d14">%s</span><span style="color:#d14">&#34;</span><span style="color:#000;font-weight:bold">%</span>(year, month, day, slug))
</code></pre></td></tr></table>
</div>
</div><p>​	本例中的URL模式定义了year、month、day、slug等4个参数。</p>
<h4 id="requesthandler">RequestHandler</h4>
<p>​	经过前面的学习，大致了解到RequestHandler类在Tornado网站程序中的重要作用，它是配置和响应URL请求的核心类，下面将介绍RequestHandler的更多内容。</p>
<ul>
<li><strong>接入点函数</strong></li>
</ul>
<p>​        需要子类继承并定义具体行为的函数在RequestHandler中被称为接入点函数(Entry Point)，之前常用的get()函数就是典型的接入点函数。其它可用的接入点函数如下所述。</p>
<p>​	（1）RequestHandler.initialize()</p>
<p>​	该方法被子类重写，实现了RequestHandler子类实例的初始化过程。可以将该函数传递参数，参数来源于配置URL映射时的定义。比如：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#000;font-weight:bold">from</span> <span style="color:#555">tornado.web</span> <span style="color:#000;font-weight:bold">import</span> RequestHandler
<span style="color:#000;font-weight:bold">from</span> <span style="color:#555">tornado.web</span> <span style="color:#000;font-weight:bold">import</span> Application

<span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">ProfileHandler</span>(RequestHandler):
    <span style="color:#000;font-weight:bold">def</span> <span style="color:#900;font-weight:bold">initialize</span>(<span style="color:#999">self</span>,database):
        <span style="color:#999">self</span><span style="color:#000;font-weight:bold">.</span>database <span style="color:#000;font-weight:bold">=</span> database
    
    <span style="color:#000;font-weight:bold">def</span> <span style="color:#900;font-weight:bold">get</span>(<span style="color:#999">self</span>):
        <span style="color:#000;font-weight:bold">pass</span>
    
    <span style="color:#000;font-weight:bold">def</span> <span style="color:#900;font-weight:bold">post</span>(<span style="color:#999">self</span>):
        <span style="color:#000;font-weight:bold">pass</span>

app <span style="color:#000;font-weight:bold">=</span> Application([(<span style="color:#d14">r</span><span style="color:#d14">&#39;/account&#39;</span>,ProfileHandler,<span style="color:#0086b3">dict</span>(database<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;c:</span><span style="color:#d14">\\</span><span style="color:#d14">example.db&#34;</span>)),])
</code></pre></td></tr></table>
</div>
</div><p>​	本例中的initialize有参数database，该参数由Application定义URL映射时以dict形式给出。</p>
<p>​	（2）RequestHandler.prepare()、RequestHandler.on_finish()</p>
<p>​	prepare()方法用于调用请求处理(get、post等)方法之前的初始化处理，而on_finish()用于请求处理结束后的一些清理工作，这两种方法一个在处理前，一个在处理后，可以根据实际需要进行重写。通常prepare()方法做资源初始化操作，而用on_finish()方法可做清理对象占用的内存或者关闭数据库连接等工作。</p>
<p>​	（3）HTTP Action处理函数</p>
<p>​	每个HTTP Action在RequestHandler中都以单独的函数进行处理。</p>
<ul>
<li>
<p>RequestHandler.get(*args,**kargs)</p>
</li>
<li>
<p>RequestHandler.head(*args,**kargs)</p>
<p>RequestHandler.post(*args,**kargs)</p>
</li>
<li>
<p>RequestHandler.delete(*args,**kargs)</p>
</li>
<li>
<p>RequestHandler.patch(*args,**kargs)</p>
</li>
<li>
<p>RequestHandler.put(*args,**kargs)</p>
<p>RequestHandler.options(*args,**kargs)</p>
<p>每个处理函数都以它们对应的HTTP Action小写的方式命名。</p>
<p><strong>输入捕获</strong></p>
</li>
</ul>
<p>​        输入捕获是指在RequestHandler中获取客户端输入的工具函数和属性，比如获取URL查询字符串、POST提交参数等。</p>
<p>​      （1）RequestHandler.get_argument(name)、RequestHandler.get_arguments(name)</p>
<p>​	都是返回给定参数的值。get_argument获得单个值；而get_arguments是针对参数存在多个值的情况下使用的，返回多个值的列表。用get_argument/get_arguments()方法获取的是URL查询字符串参数与Post提交参数的参数合集。</p>
<p>​	(2) RequestHandler.get_query_argument(name)、RequestHandler.get_query_argument</p>
<p>(name)</p>
<p>​	它们与get_argument、get_arguments的功能类似，但是仅从URL查询参数中获取参数值。</p>
<p>​	(3)RequestHandler.get_body_argument(name)、RequestHandler.get_body_arguments</p>
<p>(name)</p>
<p>​	与get_argument、get_arguments的功能类似，但是仅从Post提交参数中获取参数值。</p>
<p>​	一般来说，使用get_argument/get_arguments即可。因为它们是get_query_argument/get_query_arguments和get_body_argument/get_body_arguments的合集。</p>
<p>​	(4)RequestHandler.get_cookie(name,default=None)</p>
<p>​	根据Cookie名称获取Cookie值。</p>
<p>​	(5)RequestHandler.request</p>
<p>​	返回tornado.httputil.HTTPServerRequest对象实例的属性，通过该对象可以获取关于HTTP请求的一切信息。比如：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">tornado.web</span>

<span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">DetailHandler</span>(tornado<span style="color:#000;font-weight:bold">.</span>web<span style="color:#000;font-weight:bold">.</span>RequestHandler):
    <span style="color:#000;font-weight:bold">def</span> <span style="color:#900;font-weight:bold">get</span>():
        remote_ip <span style="color:#000;font-weight:bold">=</span> <span style="color:#999">self</span><span style="color:#000;font-weight:bold">.</span>request<span style="color:#000;font-weight:bold">.</span>remote_ip				<span style="color:#998;font-style:italic">#获取客户端IP地址</span>
        host <span style="color:#000;font-weight:bold">=</span> <span style="color:#999">self</span><span style="color:#000;font-weight:bold">.</span>request<span style="color:#000;font-weight:bold">.</span>host						<span style="color:#998;font-style:italic">#获取请求的主机地址</span>
</code></pre></td></tr></table>
</div>
</div><p>​	常用的httputil.HTTPServerRequest对象属性如下表所示：</p>
<table>
<thead>
<tr>
<th style="text-align:center">属性名</th>
<th style="text-align:center">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">method</td>
<td style="text-align:center">HTTP请求方法，比如GET、POST等</td>
</tr>
<tr>
<td style="text-align:center">url</td>
<td style="text-align:center">客户端请求的url的完整内容</td>
</tr>
<tr>
<td style="text-align:center">query</td>
<td style="text-align:center">url中的查询字符串</td>
</tr>
<tr>
<td style="text-align:center">version</td>
<td style="text-align:center">客户端发送请求时使用的HTTP版本，比如HTTP/1.1</td>
</tr>
<tr>
<td style="text-align:center">headers</td>
<td style="text-align:center">以字典方式表达的HTTP Headers</td>
</tr>
<tr>
<td style="text-align:center">body</td>
<td style="text-align:center">以字符串方式表达的HTTP消息体</td>
</tr>
<tr>
<td style="text-align:center">remote_ip</td>
<td style="text-align:center">客户端的IP地址</td>
</tr>
<tr>
<td style="text-align:center">Protocol</td>
<td style="text-align:center">请求协议，比如HTTP、HTTPS</td>
</tr>
<tr>
<td style="text-align:center">host</td>
<td style="text-align:center">请求消息中的主机名</td>
</tr>
<tr>
<td style="text-align:center">arguments</td>
<td style="text-align:center">客户端提交的所有参数</td>
</tr>
<tr>
<td style="text-align:center">files</td>
<td style="text-align:center">以字典方式表达的客户端上传的文件，每个文件名对应一个HTTPFile</td>
</tr>
<tr>
<td style="text-align:center">cookies</td>
<td style="text-align:center">客户端提交的cookie字典</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
</tbody>
</table>
<ul>
<li><strong>输出响应函数</strong></li>
</ul>
<p>​        输出响应函数是指一组为客户端生成处理结果的工具函数，开发者调用它们以控制URL的处理结果。常用的输出相应函数如下。</p>
<p>​	(1) RequestHandler.set_status(status_code,reason=None)</p>
<p>​	设置HTTP Resource中的返回码，如果有描述性的语句，则可以赋值给reason参数。</p>
<p>​	(2)RequestHandler.set_header(name,value)</p>
<p>​	以键值对的方式配置HTTP Response中的HTTP头参数。使用set_header配置的Header值将覆盖之前配置的Header，比如：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">tornado.web</span>
<span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">DetailHandler</span>(tornado<span style="color:#000;font-weight:bold">.</span>web<span style="color:#000;font-weight:bold">.</span>RequestHandler):
    <span style="color:#000;font-weight:bold">def</span> <span style="color:#900;font-weight:bold">get</span>():
        <span style="color:#999">self</span><span style="color:#000;font-weight:bold">.</span>set_header(<span style="color:#d14">&#34;NUMBER&#34;</span>,<span style="color:#099">9</span>)
        <span style="color:#999">self</span><span style="color:#000;font-weight:bold">.</span>set_header(<span style="color:#d14">&#34;LANGUAGE&#34;</span>,<span style="color:#d14">&#34;France&#34;</span>)
        <span style="color:#999">self</span><span style="color:#000;font-weight:bold">.</span>set_header(<span style="color:#d14">&#34;LANGUAGE&#34;</span>,<span style="color:#d14">&#34;Chinese&#34;</span>)
</code></pre></td></tr></table>
</div>
</div><pre><code>本例中的get()函数调用了3次set_header，但是只配置了两个header参数，最后的HTTP Header中的参数将会是：
</code></pre>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">NUMBER: <span style="color:#099">9</span>
LANGUAGE: Chinese 
</code></pre></td></tr></table>
</div>
</div><p>​	(3)RequestHandler.add_header(name,value)</p>
<p>​	以键值对的方式设置HTTP Response中的HTTP头参数。与set_header不同的是add_header配置的Header值将不会覆盖之前配置的Header，比如：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">tornado.web</span>
<span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">DetailHandler</span>(tornado<span style="color:#000;font-weight:bold">.</span>web<span style="color:#000;font-weight:bold">.</span>RequestHandler):
    <span style="color:#000;font-weight:bold">def</span> <span style="color:#900;font-weight:bold">get</span>():
        <span style="color:#999">self</span><span style="color:#000;font-weight:bold">.</span>set_header(<span style="color:#d14">&#34;NUMBER&#34;</span>,<span style="color:#099">8</span>)
        <span style="color:#999">self</span><span style="color:#000;font-weight:bold">.</span>set_header(<span style="color:#d14">&#34;LANGUAGE&#34;</span>,<span style="color:#d14">&#34;France&#34;</span>)
        <span style="color:#999">self</span><span style="color:#000;font-weight:bold">.</span>set_header(<span style="color:#d14">&#34;LANGUAGE&#34;</span>,<span style="color:#d14">&#34;Chinese&#34;</span>)
</code></pre></td></tr></table>
</div>
</div><p>​	最后HTTP Header中的参数将会是：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">NUMBER: <span style="color:#099">8</span>
LANGUAGE: France   
LANGUAGE: Chinese 
</code></pre></td></tr></table>
</div>
</div><p>​	(4)RequestHandler.write(chunk)</p>
<p>​	将给定的块作为HTTP Body发送给客户端。在一般情况下，用本函数输出字符串给客户端，如果给定的块是一个字典，则会将这个块以JSON格式发送给客户端，同时将HTTP header中的Content_type设置成application/json。</p>
<p>​	(5)RequestHandler.finish(chunk=None)</p>
<p>​	本方法通知Tornado:Response的生成工作已完成，chunk参数是需要传递给客户端的HTTP body。调用finish()后，Tornado将向客户端发送HTTP Response。本方法适用于对RequestHandler的异步请求处理，异步请求的具体方法详见3.4节。</p>
<p>注意：在同步或协程访问处理的函数中，无需调用finish()函数。</p>
<p>​	(6)RequestHandler.render(template_name, **kwargs)</p>
<p>​	用给定的参数渲染模板，可以在本函数中传入模板文件名称和模板参数，比如：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">tornado.web</span>
<span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">MainHandler</span>(tornado<span style="color:#000;font-weight:bold">.</span>web<span style="color:#000;font-weight:bold">.</span>RequestHandler):
    <span style="color:#000;font-weight:bold">def</span> <span style="color:#900;font-weight:bold">get</span>(<span style="color:#999">self</span>):
        items <span style="color:#000;font-weight:bold">=</span> [<span style="color:#d14">&#34;Python&#34;</span>,<span style="color:#d14">&#34;C++&#34;</span>,<span style="color:#d14">&#34;Java&#34;</span>]
        <span style="color:#999">self</span><span style="color:#000;font-weight:bold">.</span>render(<span style="color:#d14">&#34;template.html&#34;</span>,title<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;Tornado Template&#34;</span>,items<span style="color:#000;font-weight:bold">=</span>items)
</code></pre></td></tr></table>
</div>
</div><p>​	render()的第1个参数是对模板文件的命名，之后以命名参数的形式传入多个模板参数。Tornado的基本模板语法和Django相同，功能上弱化，高级过滤器不可用。</p>
<p>​	(7) RequestHandler.redirect(url,permanent=False,status=None)</p>
<p>​	进行页面重定向。在RequestHandler处理过程中，可以随时调用redirect()函数进行页面重定向，比如：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">tornado.web</span>

<span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">LoginHandler</span>(tornado<span style="color:#000;font-weight:bold">.</span>web<span style="color:#000;font-weight:bold">.</span>RequestHandler):
    <span style="color:#000;font-weight:bold">def</span> <span style="color:#900;font-weight:bold">get</span>(<span style="color:#999">self</span>):
        <span style="color:#999">self</span><span style="color:#000;font-weight:bold">.</span>render(<span style="color:#d14">&#34;login.html&#34;</span>,<span style="color:#0086b3">next</span><span style="color:#000;font-weight:bold">=</span><span style="color:#999">self</span><span style="color:#000;font-weight:bold">.</span>get_argument(<span style="color:#d14">&#34;next&#34;</span>,<span style="color:#d14">&#34;/&#34;</span>))
    
    <span style="color:#000;font-weight:bold">def</span> <span style="color:#900;font-weight:bold">post</span>(<span style="color:#999">self</span>):
        username <span style="color:#000;font-weight:bold">=</span> <span style="color:#999">self</span><span style="color:#000;font-weight:bold">.</span>get(<span style="color:#d14">&#34;username&#34;</span>,<span style="color:#d14">&#34;&#34;</span>)
        password <span style="color:#000;font-weight:bold">=</span> <span style="color:#999">self</span><span style="color:#000;font-weight:bold">.</span>get(<span style="color:#d14">&#34;password&#34;</span>,<span style="color:#d14">&#34;&#34;</span>)
        auth <span style="color:#000;font-weight:bold">=</span> <span style="color:#999">self</span><span style="color:#000;font-weight:bold">.</span>db<span style="color:#000;font-weight:bold">.</span>authenticate(username, password)
        <span style="color:#000;font-weight:bold">if</span> auth:
            <span style="color:#999">self</span><span style="color:#000;font-weight:bold">.</span>set_current_user(username)
            <span style="color:#999">self</span><span style="color:#000;font-weight:bold">.</span>redirect(<span style="color:#999">self</span><span style="color:#000;font-weight:bold">.</span>get_argument(<span style="color:#d14">&#34;next&#34;</span>,<span style="color:#d14">u</span><span style="color:#d14">&#34;/&#34;</span>))
        <span style="color:#000;font-weight:bold">else</span>:
            error_msg <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">u</span><span style="color:#d14">&#34;?error=&#34;</span> <span style="color:#000;font-weight:bold">+</span> tornado<span style="color:#000;font-weight:bold">.</span>escape<span style="color:#000;font-weight:bold">.</span>url_escape(<span style="color:#d14">&#34;Login incorrect.&#34;</span>)
            <span style="color:#999">self</span><span style="color:#000;font-weight:bold">.</span>redirect(<span style="color:#d14">u</span><span style="color:#d14">&#34;/login&#34;</span> <span style="color:#000;font-weight:bold">+</span> error_msg)
</code></pre></td></tr></table>
</div>
</div><p>​	在本例LoginHandler的post处理函数中，根据验证是否成功将客户端重定向到不同的页面，如果成功则重定向到next参数所指向的URL；如果不成功，则重定向到&rdquo;/login&quot;页面。</p>
<p>​	(8) RequestHandler.clear()</p>
<p>​	清空所有在本次请求中之前写入的Header和Body内容，比如：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">tornado.web</span>
<span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">DetailHandler</span>(tornado<span style="color:#000;font-weight:bold">.</span>web<span style="color:#000;font-weight:bold">.</span>RequestHandler):
    <span style="color:#000;font-weight:bold">def</span> <span style="color:#900;font-weight:bold">get</span>():
        <span style="color:#999">self</span><span style="color:#000;font-weight:bold">.</span>set_header(<span style="color:#d14">&#34;NUMBER&#34;</span>,<span style="color:#099">8</span>)
        <span style="color:#999">self</span><span style="color:#000;font-weight:bold">.</span>clear()
        <span style="color:#999">self</span><span style="color:#000;font-weight:bold">.</span>set_header(<span style="color:#d14">&#34;LANGUAGE&#34;</span>,<span style="color:#d14">&#34;France&#34;</span>)
</code></pre></td></tr></table>
</div>
</div><p>​	(9) RequestHandler.set_cookie(name,value)</p>
<p>​	按键值对设置Response中的Cookie值。</p>
<p>​	(10) RequestHandler.clear_all_cookies</p>
<p>​	清空本次请求中的所有Cookie。</p>
<h4 id="异步化及协程化">异步化及协程化</h4>
<p>​	上述例子都是用同步的方法来处理用户的请求，即在RequestHandler的get()和post()函数中完成所有的处理，当退出get()和post()等函数后马上向客户端返回Response。但是处理逻辑比较复杂或需要等待外部I/O时，这样的处理机制会阻塞服务器线程，并不适合大量客户端高并发的应用场景。</p>
<p>​	Tornado有两种方式改变同步的处理流程。</p>
<ul>
<li>异步化：针对RequestHandler的处理函数，使用@tornado.web.asynchronous修饰器，将默认的同步机制改为异步机制。</li>
<li>协程化：针对RequestHandler的处理函数，使用@tornado.gen.coroutine修饰器，将默认的同步机制改为协程机制。</li>
</ul>
<ol>
<li>
<p><strong>异步化</strong></p>
<p>异步化的RequestHandler处理如下：</p>
</li>
</ol>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">tornado.web</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">tornado.httpclient</span>

<span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">MainHandler</span>(tornado<span style="color:#000;font-weight:bold">.</span>web<span style="color:#000;font-weight:bold">.</span>RequestHandler):
    <span style="color:#3c5d5d;font-weight:bold">@tornado</span><span style="color:#000;font-weight:bold">.</span>web<span style="color:#000;font-weight:bold">.</span>asynchronous
    <span style="color:#000;font-weight:bold">def</span> <span style="color:#900;font-weight:bold">get</span>(<span style="color:#999">self</span>):
        http <span style="color:#000;font-weight:bold">=</span> tornado<span style="color:#000;font-weight:bold">.</span>httpclient<span style="color:#000;font-weight:bold">.</span>AsyncHTTPClient()
        http<span style="color:#000;font-weight:bold">.</span>fetch(<span style="color:#d14">&#34;http://www.baidu.com&#34;</span>,callback<span style="color:#000;font-weight:bold">=</span><span style="color:#999">self</span><span style="color:#000;font-weight:bold">.</span>on_respinse())
        
    <span style="color:#000;font-weight:bold">def</span> <span style="color:#900;font-weight:bold">on_resoponse</span>(<span style="color:#999">self</span>,response):
        <span style="color:#000;font-weight:bold">if</span> response<span style="color:#000;font-weight:bold">.</span>error:<span style="color:#000;font-weight:bold">raise</span> tornado<span style="color:#000;font-weight:bold">.</span>web<span style="color:#000;font-weight:bold">.</span>HTTPError(<span style="color:#099">500</span>)
        <span style="color:#999">self</span><span style="color:#000;font-weight:bold">.</span>write(response<span style="color:#000;font-weight:bold">.</span>body)
        <span style="color:#999">self</span><span style="color:#000;font-weight:bold">.</span>finish()
</code></pre></td></tr></table>
</div>
</div><p>​	本例中用装饰器tornado.web.asynchronous定义了HTTP访问处理函数get()。这样，当get()函数返回时，对该HTTP访问的请求尚未完成，所以Tornado无法发送HTTP Response给客户端。只有当在随后的on_response()中的finish()函数被调用时，Tornado才知道本次处理已完成，可以发送给Response给客户端。</p>
<p>​	异步编程虽然提高了服务器的并发能力，但编程方法繁琐。</p>
<p>2.<strong>协程化</strong></p>
<p>​	协程的编程方法示例如下：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">tornado.web</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">tornado.httpclient</span>
<span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">MainHandler</span>(tornado<span style="color:#000;font-weight:bold">.</span>web<span style="color:#000;font-weight:bold">.</span>RequestHandler):
    <span style="color:#3c5d5d;font-weight:bold">@tornado</span><span style="color:#000;font-weight:bold">.</span>gen<span style="color:#000;font-weight:bold">.</span>coroutine
    <span style="color:#000;font-weight:bold">def</span> <span style="color:#900;font-weight:bold">get</span>():
        http <span style="color:#000;font-weight:bold">=</span> tornado<span style="color:#000;font-weight:bold">.</span>httpclient<span style="color:#000;font-weight:bold">.</span>AsyncHTTPClient()
        response <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">yield</span> http<span style="color:#000;font-weight:bold">.</span>fetch(<span style="color:#d14">&#34;http://www.baidu.com&#34;</span>)
        <span style="color:#999">self</span><span style="color:#000;font-weight:bold">.</span>write(response<span style="color:#000;font-weight:bold">.</span>body)
</code></pre></td></tr></table>
</div>
</div><p>​	本例中展示仍然是一个转发网站内容的处理器，代码量与相应的同步版本差不多。协程化的关键技术点如下。</p>
<ul>
<li>用tornado.gen.coroutine装饰MainHandler的get()、post()等处理函数。</li>
<li>使用异步对象处理耗时操作，比如本例的AsyncHTTPClient。</li>
<li>调用yield关键字获取异步对象的处理结果。</li>
</ul>

    </div>

    
    
<div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">bomir</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
      2019-07-03
      
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>


    
    

    <footer class="post-footer">
      <div class="post-tags">
          <a href="https://bomir.github.io/tags/tornado/">Tornado</a>
          
        </div>

      
      <nav class="post-nav">
        
          <a class="prev" href="/post/python-common-questions/">
            
            <i class="iconfont">
              <svg  class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417 757.434875 204.940602c11.338233-12.190647 11.035334-32.285311-0.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-0.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891 0.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"></path>
</svg>

            </i>
            <span class="prev-text nav-default">Python常见题</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        
          <a class="next" href="/post/web-servers-choose/">
            <span class="next-text nav-default">web服务器纵览</span>
            <span class="prev-text nav-mobile">下一篇</span>
            
            <i class="iconfont">
              <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311 0.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889 0.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-0.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697C361.493148 60.273758 343.054193 61.470003 332.091514 74.487481z"></path>
</svg>

            </i>
          </a>
      </nav>
    </footer>
  </article>

  
  

  
  

  

  
  

  

  

  

    

  

        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="icon-links">
  
  
    <a href="mailto:jinchunw@385@gmail.com" rel="me noopener" class="iconfont"
      title="email" >
      <svg class="icon" viewBox="0 0 1451 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M664.781909 681.472759 0 97.881301C0 3.997201 71.046997 0 71.046997 0L474.477909 0 961.649408 0 1361.641813 0C1361.641813 0 1432.688811 3.997201 1432.688811 97.881301L771.345323 681.472759C771.345323 681.472759 764.482731 685.154773 753.594283 688.65053L753.594283 688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858L682.561621 688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759L664.781909 681.472759ZM718.063616 811.603883C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633 0 212.052267 0 212.052267L0 942.809523C0 942.809523 0 1024 83.726336 1024L682.532949 1024 753.579947 1024 1348.948139 1024C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523L1432.688811 212.052267C1432.688811 212.052267 893.138176 701.759633 817.019477 767.734955 777.248 802.205449 742.347691 811.03081 718.063616 811.603883L718.063616 811.603883Z"></path>
</svg>

    </a>
  
    <a href="https://github.com/Bicomir" rel="me noopener" class="iconfont"
      title="github"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M512 12.672c-282.88 0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667 0-12.16-0.426667-44.373333-0.64-87.04-142.421333 30.890667-172.458667-68.693333-172.458667-68.693333C188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333 0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333 0 0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52 0.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667 0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72 0 68.522667-0.64 123.562667-0.64 140.202666 0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"></path>
</svg>

    </a>


<a href="https://bomir.github.io/index.xml" rel="noopener alternate" type="application/rss&#43;xml"
    class="iconfont" title="rss" target="_blank">
    <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="30" height="30">
  <path d="M819.157333 1024C819.157333 574.592 449.408 204.8 0 204.8V0c561.706667 0 1024 462.293333 1024 1024h-204.842667zM140.416 743.04a140.8 140.8 0 0 1 140.501333 140.586667A140.928 140.928 0 0 1 140.074667 1024C62.72 1024 0 961.109333 0 883.626667s62.933333-140.544 140.416-140.586667zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667V345.173333c372.352 0 678.784 306.517333 678.784 678.826667z"></path>
</svg>

  </a>
   
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy;
    
      2017 -
    2021
    <span class="heart">
      
      <i class="iconfont">
        <svg class="icon" viewBox="0 0 1025 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="14" height="14">
  <path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7 0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1 0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2 0.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2 0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3 0.1-42.5-8-83.6-24-122.2z"
   fill="#8a8a8a"></path>
</svg>

      </i>
    </span><span class="author">
        bomir
        
      </span></span>

  
  

  
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont">
        
        <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="35" height="35">
  <path d="M510.866688 227.694839 95.449397 629.218702l235.761562 0-2.057869 328.796468 362.40389 0L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777l894.052392 0 0 131.813095L63.840492 195.775872 63.840492 63.962777 63.840492 63.962777zM63.840492 63.962777"></path>
</svg>

      </i>
    </div>
  </div>
  
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>




<script type="text/javascript" src="/js/main.dee43230127a73d039a734510fa896c89c3c7ce0cf0be0c7a7433f8fd69b76dc.js" integrity="sha256-3uQyMBJ6c9A5pzRRD6iWyJw8fODPC&#43;DHp0M/j9abdtw=" crossorigin="anonymous"></script>












  
    <script type="text/javascript" src="/js/load-photoswipe.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe.min.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe-ui-default.min.js"></script>
  















</body>
</html>
